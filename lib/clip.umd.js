!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.clip=e()}(this,function(){"use strict";const t=".clipWrap {position: relative; overflow: hidden; } .clipWrap .imageBoard {will-change: transform; } .clipWrap .clipContainer {position: absolute; z-index: 1 } .clipWrap .clipContainer span {position: absolute; user-select: none; border: 2px solid #fff } #lbSPAN {cursor: nw-resize; border-right-width: 0; border-bottom-width: 0 } #ltSPAN {cursor: sw-resize; border-right-width: 0; border-top-width: 0 } #rtSPAN {cursor: ne-resize; border-left-width: 0; border-bottom-width: 0 } #rbSPAN {cursor: se-resize; border-left-width: 0; border-top-width: 0 }",e={COVER:"COVER",CONTAIN:"CONTAIN"},i="rgba(0,0,0,.5)",s={showType:"CONTAIN",outPutOpt:{type:"image/png",quality:.9}},n=3,o="ontouchmove"in document.createElement("span")?20:8;class _{constructor(t){t=Object.assign({},s,t),this.container=t.container,this.sourceFile=t.sourceFile,this.showType=t.showType,this.outPutOpt=t.outPutOpt,this.clip64="",this.clipBlob=null,this.clipArrayBuffer=null,this.__board=document.createElement("canvas"),this.__ctx=this.__board.getContext("2d"),this.__clipContainer=document.createElement("div"),this.__clipRect=document.createElement("canvas"),this.__clipCtx=this.__clipRect.getContext("2d"),this.__clipSize={w:100,h:100,max:0,min:4*o},this.__startPoint={x:0,y:0},this.__downPoint={x:0,y:0},this.__posRange={x:[],y:[]},this.__clipRectPos={x:0,y:0},this.__downClipSize={w:0,h:0},this.__srcPos={x:0,y:0},this.__isMouseDown=!1,this.__resizeTarget=null,this.__boardImage=null,this.__init(),this.__injectStyle()}__injectStyle(){const e=document.querySelectorAll("style");for(let t of e)if("clipStyle"==t.id)return;const i=document.createElement("style");i.type="text/css",i.id="clipStyle",i.innerHTML=t,document.head.appendChild(i)}async __init(){this.__containerInit();const t=await this.__readImage();this.__boardImage=await this.__drawIamge(t),this.__drawMask(),this.__makeMovable(),this.container.appendChild(this.__board),this.__drawClip(),this.__drawClipMask(),this.__clipRectInit()}__containerInit(){this.container.innerHTML="",this.container.style.cssText=`background-color:${i}`,this.container.classList.add("clipWrap")}__readImage(){return new Promise((t,e)=>{const i=new Image;i.onload=(()=>{URL.revokeObjectURL(this.sourceFile),t(i)}),i.src=URL.createObjectURL(this.sourceFile)})}__setPosRange(){const t=this.container,e=t.clientWidth,i=t.clientHeight,s=this.__clipSize,n=this.__board,o=n.width,_=n.height,h=(e-s.w)/2,r=(i-s.h)/2;this.__posRange.x=[-(o+h-e),h],this.__posRange.y=[-(_+r-i),r]}__drawIamge(t){const i=this.container,s=i.clientWidth,n=i.clientHeight,o=i.clientWidth/i.clientHeight,_=t.width/t.height;let h,r,c,a;this.__clipSize;const l=function(){c=0,a=(n-(r=(h=s)/_))/2},d=function(){c=(s-(h=(r=n)*_))/2,a=0};this.showType===e.CONTAIN?_>=o?(l(),this.__clipSize.w=this.__clipSize.h=this.__clipSize.max=r<s?r:s):(d(),this.__clipSize.w=this.__clipSize.h=this.__clipSize.max=h<n?h:n):this.showType===e.COVER&&(_>=o?(d(),this.__clipSize.max=r):(l(),this.__clipSize.max=h)),this.__clipRectPos.x=c,this.__clipRectPos.y=a,this.__startPoint.x=c,this.__startPoint.y=a;const p=this.__board;return p.width=h,p.height=r,p.classList.add("imageBoard"),p.style.cssText=`transform:translate3d(${c}px,${a}px,0)`,this.__setPosRange(),this.__ctx.drawImage(t,0,0,t.width,t.height,0,0,h,r),new Promise((t,e)=>{const i=new Image;i.onload=(()=>{t(i)}),i.src=p.toDataURL("image/png")})}__drawMask(){const t=this.__board,e=this.__ctx;e.fillStyle=i,e.fillRect(0,0,t.width,t.height)}__makeMovable(){this.__board.addEventListener("mousedown",this.__down.bind(this),!1),document.addEventListener("mousemove",this.__move.bind(this),!1),document.addEventListener("mouseup",this.__up.bind(this),!1),this.__board.addEventListener("touchstart",this.__down.bind(this),!1),document.addEventListener("touchmove",this.__move.bind(this),!1),document.addEventListener("touchend",this.__up.bind(this),!1)}__down(t){this.__downPoint.x=t.pageX,this.__downPoint.y=t.pageY,this.__downClipSize.w=this.__clipSize.w,this.__downClipSize.h=this.__clipSize.h,this.__isMouseDown=!0,t.preventDefault()}__move(t){if(this.__isMouseDown&&(t.target==this.__board||t.target==this.__clipRect)&&!this.__resizeTarget){const e=this.__posRange,i=this.__clipRectPos;let s=t.pageX+this.__startPoint.x-this.__downPoint.x,n=t.pageY+this.__startPoint.y-this.__downPoint.y;s<e.x[0]&&(s=e.x[0]),s>e.x[1]&&(s=e.x[1]),n<e.y[0]&&(n=e.y[0]),n>e.y[1]&&(n=e.y[1]),this.__board.style.cssText=`transform:translate3d(${s}px,${n}px,0)`,i.x=s,i.y=n,this.__drawClip(),this.__drawClipMask(),t.preventDefault()}}__up(){const t=getComputedStyle(this.__board,null).transform.slice(7,-1).replace(/\s+/g,"").split(",").map(function(t){return parseFloat(t)});this.__startPoint.x=t[4],this.__startPoint.y=t[5],this.__isMouseDown=!1,document.removeEventListener("mousemove",this.__move),document.removeEventListener("mouseup",this.__up),document.removeEventListener("touchmove",this.__move),document.removeEventListener("touchend",this.__up)}__drawClip(){const t=this.__clipSize.w,e=this.__clipSize.h,i=this.container,s=i.clientWidth,n=i.clientHeight,o=(s-t)/2,_=(n-e)/2,h=(this.__board,this.__clipContainer),r=this.__clipRect,c=this.__clipCtx;this.__srcPos.x=o-this.__clipRectPos.x,this.__srcPos.y=_-this.__clipRectPos.y,c.clearRect(0,0,s,n),r.width=t,r.height=e,c.drawImage(this.__boardImage,this.__srcPos.x,this.__srcPos.y,t,e,0,0,t,e),h.style.cssText=`left:${o}px;top:${_}px;width:${t}px;height:${e}px;`,h.classList.add("clipContainer"),this.__setPosRange()}__drawClipMask(){const t=this.__clipCtx,e=this.__clipRect.width,i=this.__clipRect.height;t.strokeStyle="#fff";for(let s=0;s<2;s++)for(let o=0;o<=n;o++){let _,h,r,c,a;0==s?(c=_=0,h=e*o/n,r=e):1==s&&(_=i*o/n,r=h=0,c=i),a=0==s&&0==o||0==s&&o==n||1==s&&0==o||1==s&&o==n?4:1,t.save(),t.lineWidth=a,t.translate(_,h),t.beginPath(),t.moveTo(0,0),t.lineTo(r,c),t.stroke(),t.restore()}}__clipRectInit(){const t=this.__clipRect,e=this.__clipContainer;["ltSPAN","lbSPAN","rtSPAN","rbSPAN"].forEach(function(t){const i=document.createElement("span"),s=`width:${2*o}px;height:${2*o}px;z-index:2`;switch(t){case"lbSPAN":i.style.cssText=`${s};left:-4px;top:-4px;`;break;case"ltSPAN":i.style.cssText=`${s};left:-4px;bottom:-4px;`;break;case"rtSPAN":i.style.cssText=`${s};right:-4px;top:-4px;`;break;case"rbSPAN":i.style.cssText=`${s};right:-4px;bottom:-4px;`}i.id=t,e.appendChild(i)}),e.addEventListener("mousedown",this.__down.bind(this),!1),e.addEventListener("mousedown",this.__bindClipEvent.bind(this),!1),e.addEventListener("touchstart",this.__down.bind(this),!1),e.addEventListener("touchstart",this.__bindClipEvent.bind(this),!1),e.appendChild(t),this.container.appendChild(e)}__bindClipEvent(t){this.__resizeTarget=t.target.id,document.addEventListener("mousemove",this.__clipRectResize.bind(this),!1),document.addEventListener("mouseup",this.__clipRectUp.bind(this),!1),document.addEventListener("touchmove",this.__clipRectResize.bind(this),!1),document.addEventListener("touchend",this.__clipRectUp.bind(this),!1),t.preventDefault()}__clipRectResize(t){if(this.__isMouseDown&&this.__resizeTarget){const e=this.__clipRect,i=(t.offsetX,t.offsetY,2*(t.pageX-this.__downPoint.x)),s=(t.pageY,this.__downPoint.y,e.width,e.height,this.__downClipSize),n=this.__clipSize;"ltSPAN"==this.__resizeTarget||"lbSPAN"==this.__resizeTarget?n.w=n.h=s.w-i:n.w=n.h=s.w+i,n.w<n.min||n.h<n.min?n.w=n.h=n.min:(n.w>n.max||n.h>n.max)&&(n.w=n.h=n.max),this.__drawClip(),this.__drawClipMask(),t.preventDefault()}}__clipRectUp(){this.__resizeTarget=null,document.removeEventListener("mousemove",this.__clipRectResize),document.removeEventListener("mouseup",this.__clipRectUp),document.removeEventListener("touchmove",this.__clipRectResize),document.removeEventListener("touchend",this.__clipRectUp)}async getClip(){const t=document.createElement("canvas"),e=t.getContext("2d"),i=this.__clipSize,s=i.w,n=i.h;t.width=s,t.height=n,e.drawImage(this.__boardImage,this.__srcPos.x,this.__srcPos.y,s,n,0,0,s,n),this.clip64=t.toDataURL(this.outPutOpt.type,this.outPutOpt.quality);const o=await this.__outPutBinary();return this.clipBlob=o.blob,this.clipArrayBuffer=o.arrayBuffer,Promise.resolve()}__outPutBinary(){const t=this;return new Promise(function(e,i){const s=t.clip64.split(","),n=s[0].match(/:(.*?);/)[1],o=atob(s[1]);let _=o.length;const h=new ArrayBuffer(_),r=new Uint8Array(h);for(;_--;)r[_]=o.charCodeAt(_);e({blob:new Blob([r],{type:n}),arrayBuffer:r.buffer})})}exportImage(){const t=document.createElement("a");t.download="clip__image",t.href=this.clip64,t.click()}reset(){this.__clipSize={w:100,h:100,max:0,min:4*o},this.__init()}}return function(t,e,i){return new _(t,e,i)}});
